<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Feedback paper prompt-builder</title>
  <style>
    :root{
      --bg:#f0f7ff;
      --bgSoft:#e5f1fb;
      --panel:#ffffff;
      --panelAlt:#f7f9fc;
      --border:#d2dbe6;
      --text:#0f172a;
      --muted:#4b5563;
      --accent:#0b8ce5;
      --accentSoft:rgba(11,140,229,.18);
      --good:#3cbf84;
      --warn:#d68a00;
      --bad:#d14343;
      --shadow:0 16px 36px rgba(11,140,229,.2);
      --input:#f6f9fd;
      --inputFocus:#ffffff;
      --pillBg:#e6f2ff;
      --sideBg:radial-gradient(circle at top,rgba(11,140,229,.16),transparent 55%);
      --shellBg:linear-gradient(135deg,#ffffff,#eaf3ff 45%,#f6fbff);
      --shellBorder:rgba(8,29,64,.12);
      --divider:rgba(15,23,42,.08);
      --rLg:14px;
      --rXl:18px;
    }

    [data-theme="dark"]{
      --bg:#0b1020;
      --bgSoft:#050712;
      --panel:#151a2c;
      --panelAlt:#0f1322;
      --border:#252b40;
      --text:#f5f7ff;
      --muted:#a7b0c2;
      --accent:#2aa0e6;
      --accentSoft:rgba(42,160,230,.2);
      --good:#3cbf84;
      --warn:#ffb020;
      --bad:#ff5a5a;
      --shadow:0 18px 45px rgba(0,0,0,.6);
      --input:rgba(15,23,42,.95);
      --inputFocus:rgba(15,23,42,1);
      --pillBg:rgba(0,0,0,.18);
      --sideBg:radial-gradient(circle at top,rgba(8,125,186,.12),transparent 55%);
      --shellBg:linear-gradient(145deg,rgba(29,35,61,.98),rgba(7,10,22,.98));
      --shellBorder:rgba(255,255,255,.04);
      --divider:rgba(255,255,255,.04);
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}
    body{
      margin:0;min-height:100vh;
      background:radial-gradient(circle at top left,var(--bg),var(--bgSoft) 55%);
      color:var(--text);
      display:flex;align-items:stretch;justify-content:center
    }
    .shell{
      width:100%;max-width:1180px;margin:24px;
      background:var(--shellBg);
      border-radius:22px;box-shadow:var(--shadow);
      border:1px solid var(--shellBorder);
      overflow:hidden;display:flex;flex-direction:column
    }
    header{
      padding:18px 22px 14px 22px;
      border-bottom:1px solid var(--divider);
      display:flex;gap:14px;align-items:center
    }
    .badge{
      padding:4px 10px;border-radius:999px;
      font-size:11px;letter-spacing:.05em;text-transform:uppercase;
      background:linear-gradient(135deg,rgba(11,140,229,.14),rgba(11,140,229,.22));
      color:#0b4f7a;
      border:1px solid rgba(11,140,229,.35);
      box-shadow:0 8px 16px rgba(11,140,229,.15)
    }
    .title{display:flex;flex-direction:column;gap:2px}
    .title h1{margin:0;font-size:18px;font-weight:650;letter-spacing:.01em}
    .title p{margin:0;font-size:12px;color:var(--muted)}
    .topRight{margin-left:auto;display:flex;gap:8px;align-items:center}
    .pill{
      font-size:11px;padding:4px 8px;border-radius:999px;
      border:1px solid rgba(11,140,229,.25);
      color:#0f4a75;background:linear-gradient(135deg,rgba(11,140,229,.08),rgba(11,140,229,.14));
      display:flex;gap:6px;align-items:center
    }
    .pill .dot{width:6px;height:6px;border-radius:999px;background:var(--accent)}
    .pill.active{border-color:var(--accent);color:#04365c;background:linear-gradient(135deg,var(--accentSoft),rgba(11,140,229,.28))}
    .pill.active .dot{background:var(--panel)}

    .themeToggle{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:12px;border:1px solid var(--border);
      background:var(--panelAlt);color:var(--text);font-size:12px;
      cursor:pointer;transition:background .12s ease,border-color .12s ease,transform .08s ease;
      position:fixed;bottom:22px;right:22px;z-index:20;
    }
    .themeToggle:hover{background:var(--accentSoft);border-color:var(--accent);transform:translateY(-1px)}
    .themeToggle .icon{font-size:14px}

    main{display:grid;grid-template-columns:280px 1fr;min-height:560px}
    @media(max-width:920px){main{grid-template-columns:1fr}.side{border-right:none;border-bottom:1px solid var(--border)}}

    .side{
      padding:16px 14px;border-right:1px solid var(--border);
      background:var(--sideBg);
      box-shadow:inset -1px 0 0 rgba(11,140,229,.12)
    }
    .side h2{margin:0 0 10px 0;font-size:13px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted)}
    .taskList{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
    .taskItem{
      border-radius:10px;padding:8px 10px;
      border:1px solid transparent;cursor:pointer;
      display:flex;flex-direction:column;gap:2px
    }
    .taskItem strong{font-size:13px;font-weight:650}
    .taskItem small{font-size:11px;color:var(--muted)}
    .taskItem.active{background:var(--accentSoft);border-color:var(--accent);box-shadow:0 0 0 1px rgba(8,125,186,.28)}
    .taskItem.completed:not(.active){border-color:rgba(60,191,132,.6);background:rgba(60,191,132,.12)}

    .sideBox{
      margin-top:18px;font-size:11px;padding:10px;border-radius:10px;
      border:1px dashed rgba(148,163,184,.5);
      color:var(--muted);background:var(--panelAlt)
    }
    .sideBox strong{color:var(--text)}

    .content{padding:18px 20px 16px 20px;overflow-y:auto}
    .step{display:none;animation:fadeIn .18s ease-out}
    .step.active{display:block}
    .step h2{margin:0 0 8px 0;font-size:17px;font-weight:650}
    .step p.desc{margin:0 0 16px 0;font-size:13px;color:var(--muted)}

    .metaRow{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;font-size:11px;color:var(--muted)}
    .metaRow span{padding:3px 8px;border-radius:999px;border:1px solid rgba(148,163,184,.4);background:var(--panelAlt)}
    .metaRow span.role{border-color:rgba(8,125,186,.4);color:var(--accent);background:var(--accentSoft)}
    .metaRow span.purpose{border-color:rgba(252,211,77,.6);color:#b7791f;background:rgba(252,211,77,.12)}

    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:18px 18px}
    .field{
      display:flex;flex-direction:column;gap:6px;
      padding:12px;border:1px solid var(--border);border-radius:12px;
      background:var(--panel);height:100%;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.35);
    }
    .grid>.field{height:100%}
    .field label{font-size:12px;color:var(--text);display:flex;justify-content:space-between;align-items:flex-start;gap:6px;min-height:36px;line-height:1.35}
    .flag{font-size:10px;padding:1px 6px;border-radius:999px;border:1px solid rgba(148,163,184,.7);color:var(--muted);text-transform:uppercase;letter-spacing:.06em}
    .flag.mand{border-color:rgba(239,68,68,.8);color:#fecaca}

    textarea,input,select{
      border-radius:10px;border:1px solid var(--border);
      background:var(--input);color:var(--text);
      padding:12px 12px;font-size:13px;line-height:1.5;outline:none;
      min-height:48px;width:100%;
      transition:border-color .12s ease,box-shadow .12s ease,background .12s ease;
    }
    textarea{resize:vertical;min-height:110px}
    .repeatItem textarea{min-height:130px}
    .grid .field:only-child textarea{min-height:220px}
    textarea:focus,input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 1px rgba(8,125,186,.35);background:var(--inputFocus)}
    .hint{font-size:11px;color:var(--muted)}
    .missing textarea,.missing input,.missing select{border-color:var(--bad);box-shadow:0 0 0 1px rgba(248,113,113,.5)}

    .repeatWrap{margin-top:10px;border-radius:12px;background:var(--panel)}
    .repeatTop{padding:10px 12px;display:flex;gap:10px;align-items:center;background:var(--panelAlt);border:1px solid var(--divider);border-radius:12px}
    .repeatTop .spacer{margin-left:auto}
    .repeatBody{padding:12px 4px 4px 4px}
    .repeatItem{border-radius:12px;padding:12px 14px;margin-bottom:12px;background:linear-gradient(180deg,var(--panel),var(--panelAlt));box-shadow:0 6px 18px rgba(15,23,42,.16);border:1px solid var(--divider)}
    .repeatItem:last-child{margin-bottom:0}
    .repeatItemHead{display:flex;gap:10px;align-items:center;margin-bottom:12px}
    .repeatItemHead strong{font-size:13px;font-weight:650}
    .repeatItemHead small{font-size:11px;color:var(--muted)}
    .repeatItem .grid{gap:12px}
    .repeatItem .field{border:none;background:transparent;box-shadow:none;padding:0}
    .repeatItem .field label{padding:0 4px}
    .miniBtn{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:var(--panel);color:var(--text);cursor:pointer}
    .miniBtn:hover{background:var(--accentSoft);border-color:var(--accent)}
    details{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:var(--panelAlt)}
    details[open]{background:var(--panel)}
    summary.miniSummary{cursor:pointer;font-weight:650;font-size:12px;color:var(--text)}
    summary.miniSummary::-webkit-details-marker{display:none}

    footer{
      padding:10px 16px 14px 16px;border-top:1px solid var(--divider);
      display:flex;flex-direction:column;gap:10px
    }
    .nav{display:flex;gap:8px}
    .footerRow{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:space-between}
    .footerActions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    button{
      border-radius:999px;border:1px solid transparent;
      font-size:13px;padding:7px 14px;cursor:pointer;
      background:var(--panelAlt);color:var(--text);
      transition:background .12s ease,border-color .12s ease,transform .08s ease
    }
    button:disabled{opacity:.5;cursor:default}
    .secondary{border-color:var(--border);background:var(--panel)}
    .secondary:hover:not(:disabled){background:var(--accentSoft);transform:translateY(-1px);border-color:var(--accent)}
    .primary{
      background:linear-gradient(135deg,var(--accent),#045e8d);
      border-color:rgba(8,125,186,.15);
      box-shadow:0 12px 28px rgba(8,125,186,.35);color:#f8fbff
    }
    .primary:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 14px 32px rgba(8,125,186,.45)}
    .note{margin-left:auto;font-size:11px;color:var(--muted)}
    .note strong{color:var(--text)}

    @keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="badge">Regulation</div>
      <div class="title">
        <h1>Feedback prompt builder</h1>
        <p>One-page workspace for drafting consultation response prompts.</p>
      </div>
      <div class="topRight">
        <button class="themeToggle" id="themeToggle"><span class="icon">üåû</span><span class="label">Light</span></button>
        <div class="pill" id="progressPill"><span class="dot"></span><span id="progressText">Step 1 of 9</span></div>
      </div>
    </header>

    <main>
      <aside class="side">
        <h2>Steps</h2>
        <ul class="taskList" id="taskList">
          <li class="taskItem active" data-step="1"><strong>1. Frame metadata</strong><small>Front matter and anchors.</small></li>
          <li class="taskItem" data-step="2"><strong>2. Contents skeleton</strong><small>Editable template.</small></li>
          <li class="taskItem" data-step="3"><strong>3. Consultation scope recap</strong><small>What was covered, tightly.</small></li>
          <li class="taskItem" data-step="4"><strong>4. Background context</strong><small>Why now, why this route.</small></li>
          <li class="taskItem" data-step="5"><strong>5. Engagement facts</strong><small>Responses and activity stats.</small></li>
          <li class="taskItem" data-step="6"><strong>6. International context</strong><small>Whitelist only.</small></li>
          <li class="taskItem" data-step="7"><strong>7. Feedback themes</strong><small>Theme distillation.</small></li>
          <li class="taskItem" data-step="8"><strong>8. Policy position & next steps</strong><small>Decisions and timeline.</small></li>
          <li class="taskItem" data-step="9"><strong>9. Question modules, respondents, glossary</strong><small>The engine and back matter.</small></li>
          <li class="taskItem" data-step="gc"><strong>Optional global controls</strong><small>Advanced overrides only.</small></li>
        </ul>

        <div class="sideBox">
          <strong>Output</strong><br />
          Download a Word <code>.doc</code> containing ten prompts including the final assembly check. Paste each prompt into your LLM agent to generate the corresponding section.
        </div>
      </aside>

      <section class="content">
        <!-- Step 1 -->
        <section class="step active" data-step="1">
          <h2>Step 1: set the frame metadata</h2>
          <p class="desc">Front matter anchors. Keep it administrative and plain.</p>
          <div class="metaRow">
            <span class="role">Role: lead drafter</span>
            <span class="purpose">Purpose: front matter</span>
            <span>Style: factual, neutral</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Feedback paper title <span class="flag mand">Mandatory</span></label>
              <input id="s1_feedbackTitle" placeholder="Example: Feedback on CP 1/2026 Sustainable finance proposals" />
              <small class="hint">As shown on the feedback paper cover page.</small>
            </div>
            <div class="field" data-required="true">
              <label>Consultation title <span class="flag mand">Mandatory</span></label>
              <input id="s1_consultationTitle" placeholder="Example: CP 1/2026 Sustainable finance proposals" />
              <small class="hint">Use the public consultation title as issued.</small>
            </div>
            <div class="field" data-required="true">
              <label>Consultation publication date <span class="flag mand">Mandatory</span></label>
              <input id="s1_pubdate" placeholder="Example: 12 January 2026" />
              <small class="hint">As shown on the consultation document.</small>
            </div>
            <div class="field" data-required="true">
              <label>Public URL for consultation <span class="flag mand">Mandatory</span></label>
              <input id="s1_url" placeholder="Example: https://..." />
              <small class="hint">One stable public link.</small>
            </div>
            <div class="field" data-required="true">
              <label>One sentence: what this feedback paper reports <span class="flag mand">Mandatory</span></label>
              <textarea id="s1_oneliner" placeholder="Example: This feedback paper summarises responses received to the consultation and sets out our intended approach." ></textarea>
              <small class="hint">Keep it tight and descriptive.</small>
            </div>
            <div class="field" data-required="true">
              <label>Contact inbox for enquiries <span class="flag mand">Mandatory</span></label>
              <input id="s1_inbox" placeholder="Example: consultation@regulator.xx" />
              <small class="hint">One mailbox.</small>
            </div>
            <div class="field" data-required="true">
              <label>Issue month and year for feedback paper <span class="flag mand">Mandatory</span></label>
              <input id="s1_issue" placeholder="Example: March 2026" />
              <small class="hint">Used on the cover page.</small>
            </div>
            <div class="field">
              <label>Document reference / code <span class="flag">Optional</span></label>
              <input id="s1_ref" placeholder="Example: FP 1/2026" />
              <small class="hint">If you use an internal doc numbering scheme.</small>
            </div>
            <div class="field">
              <label>Document series prefix for filenames <span class="flag">Optional</span></label>
              <input id="g_prefix" placeholder="Example: FP2026_" />
              <small class="hint">Prepends exported filenames if set.</small>
            </div>
          </div>
        </section>

        <!-- Step 2 (editable template) -->
        <section class="step" data-step="2">
          <h2>Step 2: confirm the contents skeleton</h2>
          <p class="desc">This step sets the contents template used in the prompts. You can leave the default as-is.</p>
          <div class="metaRow">
            <span class="role">Role: fixed automation</span>
            <span class="purpose">Purpose: lock the document spine</span>
          </div>
          <p class="hint">This template controls the contents structure in the drafted paper. You can leave the default as-is.</p>
          <div class="grid">
            <div class="field">
              <label>Contents template (editable)</label>
              <textarea id="s2_template" placeholder="Contents template"></textarea>
              <small class="hint">Edit only if you need to change the structure. Placeholders for thematic headings will auto-fill if you use the default.</small>
            </div>
          </div>
        </section>

        <!-- Step 3 -->
        <section class="step" data-step="3">
          <h2>Step 3: restate what the consultation covered</h2>
          <p class="desc">Lead with scope, not conclusions. Two or three key areas is enough.</p>
          <div class="metaRow">
            <span class="role">Role: senior policy drafter</span>
            <span class="purpose">Purpose: executive summary, introduction</span>
            <span>Style: short bullets</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Key areas addressed (2 to 3) <span class="flag mand">Mandatory</span></label>
              <textarea id="s3_areas" placeholder="Example:
- Governance and oversight expectations
- Disclosure and anti-greenwashing controls
- Transition planning and risk management"></textarea>
              <small class="hint">Bullets are fine.</small>
            </div>
            <div class="field" data-required="true">
              <label>Regulated population in scope <span class="flag mand">Mandatory</span></label>
              <textarea id="s3_population" placeholder="Example: registered persons carrying on investment business, fund services, and deposit taking business"></textarea>
              <small class="hint">High level description only.</small>
            </div>
            <div class="field" data-required="true">
              <label>Number of consultation questions <span class="flag mand">Mandatory</span></label>
              <input id="s3_qcount" placeholder="Example: 18" />
              <small class="hint">Just the number.</small>
            </div>
          </div>
        </section>

        <!-- Step 4 -->
        <section class="step" data-step="4">
          <h2>Step 4: set out policy and programme context</h2>
          <p class="desc">Write background as why now, why this route, why this audience. Avoid advocacy.</p>
          <div class="metaRow">
            <span class="role">Role: policy lead</span>
            <span class="purpose">Purpose: executive summary, background</span>
            <span>Lens: regulatory rationale</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Internal drivers and programme references <span class="flag mand">Mandatory</span></label>
              <textarea id="s4_drivers" placeholder="Example: strategic plan 2025-27 objective on business integrity; workplan item; Board decision date"></textarea>
              <small class="hint">Include internal drivers, action plan references, earlier steps.</small>
            </div>
            <div class="field">
              <label>What changed since related work <span class="flag">Optional</span></label>
              <textarea id="s4_changed" placeholder="Example: new international standard; thematic review findings; market growth; emerging conduct risks"></textarea>
              <small class="hint">If nothing changed, leave blank.</small>
            </div>
          </div>
        </section>

        <!-- Step 5 -->
        <section class="step" data-step="5">
          <h2>Step 5: capture engagement facts</h2>
          <p class="desc">Treat these as audit facts, one pass. Keep them consistent across the document.</p>
          <div class="metaRow">
            <span class="role">Role: consultation manager</span>
            <span class="purpose">Purpose: engagement facts paragraph and respondents section</span>
            <span>Handling: factual counts</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Number of formal responses <span class="flag mand">Mandatory</span></label>
              <input id="s5_responses" placeholder="Example: 12" />
              <small class="hint">Formal written submissions received.</small>
            </div>
            <div class="field">
              <label>Events held and participation <span class="flag">Optional</span></label>
              <textarea id="s5_events" placeholder="Example: 2 drop-in sessions (35 participants total); 1 industry roundtable"></textarea>
              <small class="hint">Include format and rough counts.</small>
            </div>
            <div class="field" data-required="true">
              <label>Respondent categories (broad) <span class="flag mand">Mandatory</span></label>
              <textarea id="s5_categories" placeholder="Example: supervised entities; industry associations; professional advisers"></textarea>
              <small class="hint">Do not identify individual respondents here.</small>
            </div>
            <div class="field">
              <label>Confidentiality handling notes <span class="flag">Optional</span></label>
              <textarea id="s5_conf" placeholder="Example: submissions treated as non-confidential unless stated; anonymised quotes only"></textarea>
              <small class="hint">Only include what you actually do.</small>
            </div>
          </div>
        </section>

        <!-- Step 6 -->
        <section class="step" data-step="6">
          <h2>Step 6: international context for calibration</h2>
          <p class="desc">Whitelist-only external developments. No invention, no extras.</p>
          <div class="metaRow">
            <span class="role">Role: policy analyst</span>
            <span class="purpose">Purpose: executive summary, international context</span>
            <span>Rule: whitelist only</span>
          </div>
          <div class="grid">
            <div class="field">
              <label>External developments (bullets) <span class="flag">Optional</span></label>
              <textarea id="s6_devs" placeholder="Example:
- EU: CSRD and ESRS implementation
- UK: FCA SDR and anti-greenwashing rule
- US: SEC climate disclosure debates"></textarea>
              <small class="hint">Bullet entries only. If fewer than two, the export will instruct omission.</small>
            </div>
          </div>
        </section>

        <!-- Step 7 -->
        <section class="step" data-step="7">
          <h2>Step 7: distil feedback themes</h2>
          <p class="desc">Four to six themes, phrased neutrally. Each theme should include what was said and the tension it creates.</p>
          <div class="metaRow">
            <span class="role">Role: synthesis lead</span>
            <span class="purpose">Purpose: executive summary, feedback summary</span>
            <span>Output: themes</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Coding frame <span class="flag mand">Mandatory</span></label>
              <textarea id="s7_frame" placeholder="Default: intent; method; definitions; proportionality; burden; alignment"></textarea>
              <small class="hint">Comma separated or short list.</small>
            </div>
            <div class="field" data-required="true">
              <label>Theme candidates (4 to 6) <span class="flag mand">Mandatory</span></label>
              <textarea id="s7_themes" placeholder="Example:
1) Proportionality requests for smaller firms
2) Clarification of definitions and scope
3) Implementation timeframes and transition
4) Evidence expectations and data sources
5) Supervisory approach and assurance"></textarea>
              <small class="hint">Numbered list is easiest.</small>
            </div>
            <div class="field">
              <label>Any notable divergences <span class="flag">Optional</span></label>
              <textarea id="s7_div" placeholder="Example: associations broadly supportive, some firms raised burden concerns on reporting"></textarea>
              <small class="hint">High level only.</small>
            </div>
          </div>
        </section>

        <!-- Step 8 -->
        <section class="step" data-step="8">
          <h2>Step 8: policy position and next steps</h2>
          <p class="desc">State decisions clearly, then what changed due to feedback, then what happens next. Include timeline anchors.</p>
          <div class="metaRow">
            <span class="role">Role: decision drafter</span>
            <span class="purpose">Purpose: executive summary, policy position and next steps</span>
            <span>Output: decisions and timetable</span>
          </div>
          <div class="grid">
            <div class="field" data-required="true">
              <label>Decisions list <span class="flag mand">Mandatory</span></label>
              <textarea id="s8_decisions" placeholder="Example:
- Accept Proposal A with amendments
- Defer Proposal B pending further evidence
- Reject Option C"></textarea>
              <small class="hint">Use accept, amend, defer, reject, or similar.</small>
            </div>
            <div class="field" data-required="true">
              <label>Delivery route <span class="flag mand">Mandatory</span></label>
              <textarea id="s8_route" placeholder="Example: update to Codes of Practice; supporting guidance note; supervision messaging; training; transition period"></textarea>
              <small class="hint">Mechanism for implementation.</small>
            </div>
            <div class="field" data-required="true">
              <label>Timeline anchors <span class="flag mand">Mandatory</span></label>
              <textarea id="s8_timeline" placeholder="Example:
- Q2 2026: publish final guidance
- Q3 2026: Codes updated
- 6 months transition period"></textarea>
              <small class="hint">Quarters and months are fine.</small>
            </div>
            <div class="field">
              <label>What changed due to feedback <span class="flag">Optional</span></label>
              <textarea id="s8_changed" placeholder="Example: narrowed scope for small firms; added examples; extended transition"></textarea>
              <small class="hint">Keep it concrete.</small>
            </div>
          </div>
        </section>

        <!-- Step 9 -->
        <section class="step" data-step="9">
          <h2>Step 9: build question modules, respondents table, glossary</h2>
          <p class="desc">Create repeatable question modules, then safe respondent counts by sector, then a glossary of defined terms.</p>
          <div class="metaRow">
            <span class="role">Role: section drafter</span>
            <span class="purpose">Purpose: main body modules and back matter</span>
            <span>Module: overview, feedback, response, outcome</span>
          </div>

          <div class="repeatWrap">
            <div class="repeatTop">
              <strong style="font-size:13px">Question modules</strong>
              <span class="hint">Add as many as needed. The export will include a prompt per module.</span>
              <span class="spacer"></span>
              <button class="miniBtn" id="addQ">+ Add question</button>
            </div>
            <div class="repeatBody" id="qContainer"></div>
          </div>

          <div class="repeatWrap" style="margin-top:14px">
            <div class="repeatTop">
              <strong style="font-size:13px">Respondent counts by sector</strong>
              <span class="hint">Sector and count only, safe and informative.</span>
              <span class="spacer"></span>
              <button class="miniBtn" id="addSector">+ Add sector line</button>
            </div>
            <div class="repeatBody" id="sectorContainer"></div>
          </div>

          <div class="repeatWrap" style="margin-top:14px">
            <div class="repeatTop">
              <strong style="font-size:13px">Glossary terms</strong>
              <span class="hint">Defined terms and abbreviations used in the paper.</span>
              <span class="spacer"></span>
              <button class="miniBtn" id="addTerm">+ Add term</button>
            </div>
            <div class="repeatBody" id="termContainer"></div>
          </div>

          <div class="grid" style="margin-top:14px">
            <div class="field" data-required="true">
              <label>Quantification approach language <span class="flag mand">Mandatory</span></label>
              <textarea id="s9_quant" placeholder="Default: Use exact counts only where supported. Otherwise use consistent qualitative descriptors such as most, many, some, a minority."></textarea>
              <small class="hint">This becomes a constraint in your prompts.</small>
            </div>
            <div class="field" data-required="true">
              <label>Tone and framing constraints <span class="flag mand">Mandatory</span></label>
              <textarea id="s9_tone" placeholder="Default: factual, procedural, decision-led; acknowledge diverging views; apply proportionality; avoid overpromising; commit to concrete next actions."></textarea>
              <small class="hint">Baked into every agent prompt.</small>
            </div>
          </div>
        </section>

        <section class="step" data-step="gc">
          <h2>Optional global controls</h2>
          <p class="desc">Use only if you need to override the fixed regulator allowlist across all prompts.</p>
          <div class="metaRow">
            <span class="role">Scope: applies to all steps</span>
            <span class="purpose">Purpose: advanced guardrails</span>
          </div>
          <div class="grid">
            <div class="field">
              <label>Fixed regulator and jurisdiction</label>
              <div class="pill" aria-live="polite">Regulator: JFSC ¬∑ Jurisdiction: Jersey</div>
              <small class="hint">Locked to match the house style.</small>
            </div>
            <div class="field">
              <label>Default allowed institutions list</label>
              <div class="pill" aria-live="polite">JFSC, Jersey, Government of Jersey, States of Jersey, EU, UK, FCA</div>
              <small class="hint">Stays in force unless you open the override below.</small>
            </div>
            <div class="field">
              <label>Advanced: allowed list override <span class="flag">Optional</span></label>
              <details id="allowedOverride">
                <summary class="miniSummary">Override default allowlist (off by default)</summary>
                <textarea id="g_allowed" placeholder="Comma separated list"></textarea>
                <small class="hint">Defaults to the internal allowlist above when closed. Open only if you need to add or replace entries.</small>
              </details>
            </div>
          </div>
        </section>

      </section>
    </main>

    <footer>
      <div class="footerRow">
        <div class="nav">
          <button class="secondary" id="prev">‚Üê Back</button>
          <button class="secondary" id="next">Next ‚Üí</button>
        </div>
        <div class="footerActions">
          <button class="primary" id="export">Download Word prompts</button>
        </div>
      </div>
      <div class="note"><strong>File:</strong> [prefix]feedback_paper_agent_prompts[optional_ref].doc (applied on export)</div>
    </footer>
  </div>

<script>
(function(){
  const DEFAULT_CONTENTS_TEMPLATE = `Contents

1. Executive summary
   Introduction
   Background
   International context
   Feedback summary
   Policy position and next steps
2. Consultation feedback and our comments
   [thematic heading 1]
   [thematic heading 2]
3. List of respondents
   Glossary`;
  const DEFAULT_REGULATOR = 'JFSC';
  const DEFAULT_JURISDICTION = 'Jersey';
  const DEFAULT_ALLOWED_LIST = 'JFSC, Jersey, Government of Jersey, States of Jersey, EU, UK, FCA';
  const DISALLOWED_TOKEN = '[not included: not in allowed list]';

  const root = document.documentElement;
  const themeToggle = document.getElementById('themeToggle');
  const THEME_KEY = 'fp-theme';

  function setTheme(theme){
    const next = theme === 'dark' ? 'dark' : 'light';
    root.setAttribute('data-theme', next);
    if(themeToggle){
      const icon = themeToggle.querySelector('.icon');
      const label = themeToggle.querySelector('.label');
      if(icon) icon.textContent = next === 'dark' ? 'üåô' : 'üåû';
      if(label) label.textContent = next === 'dark' ? 'Dark' : 'Light';
    }
  }

  const storedTheme = localStorage.getItem(THEME_KEY);
  setTheme(storedTheme || 'light');

  themeToggle?.addEventListener('click',()=>{
    const current = root.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
    const next = current === 'dark' ? 'light' : 'dark';
    setTheme(next);
    localStorage.setItem(THEME_KEY, next);
  });

  const steps = Array.from(document.querySelectorAll('.step'));
  const nonGlobalSteps = steps.filter(s=>s.dataset.step !== 'gc');
  const items = Array.from(document.querySelectorAll('.taskItem'));
  const prev = document.getElementById('prev');
  const next = document.getElementById('next');
  const exportBtn = document.getElementById('export');
  const allowedOverride = document.getElementById('allowedOverride');
  const progressText = document.getElementById('progressText');
  const progressPill = document.getElementById('progressPill');
  const s2TemplateEl = document.getElementById('s2_template');
  let s2IsDefault = true;
  let current = 0;

  function seedDefaultContentsTemplate(){
    if(!s2TemplateEl) return;
    const hasValue = (s2TemplateEl.value || '').trim().length > 0;
    if(!hasValue){
      s2TemplateEl.value = DEFAULT_CONTENTS_TEMPLATE;
      s2IsDefault = true;
    }
  }

  function show(n){
    if(n<0||n>=steps.length) return;
    steps.forEach((s,i)=>s.classList.toggle('active',i===n));
    items.forEach((it,i)=>{
      it.classList.toggle('active',i===n);
      if(i<n) it.classList.add('completed'); else it.classList.remove('completed');
    });
    current=n;
    prev.disabled = n===0;
    next.disabled = n===steps.length-1;
    const step = steps[n];
    if(step.dataset.step === 'gc'){
      progressText.textContent = 'Optional global controls';
    } else {
      const idx = nonGlobalSteps.indexOf(step) + 1;
      progressText.textContent = 'Step ' + idx + ' of ' + nonGlobalSteps.length;
    }
    const lastNonGlobal = nonGlobalSteps[nonGlobalSteps.length-1];
    const pastCoreWork = step === lastNonGlobal || step.dataset.step === 'gc';
    if(pastCoreWork) progressPill.classList.add('active'); else progressPill.classList.remove('active');
  }

  items.forEach((it,i)=>it.addEventListener('click',()=>show(i)));
  prev.addEventListener('click',()=>show(current-1));
  next.addEventListener('click',()=>{
    // nudge validation on navigation to avoid end-of-work surprise
    validateStep(current,true);
    show(current+1);
  });

  function get(id){
    const el=document.getElementById(id);
    return el? (el.value||'').trim():'';
  }

  s2TemplateEl?.addEventListener('input',()=>{ s2IsDefault = false; });
  seedDefaultContentsTemplate();

  function esc(s){
    return (s||'')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;');
  }

  function validateStep(stepIndex,soft){
    const step = steps[stepIndex];
    if(!step) return true;
    let ok=true;
    const fields = Array.from(step.querySelectorAll('.field[data-required="true"]'));
    fields.forEach(f=>{
      const input = f.querySelector('textarea,input,select');
      const has = input && input.value && input.value.trim().length;
      if(!has){ f.classList.add('missing'); ok=false; }
      else f.classList.remove('missing');
    });
    if(!ok && !soft){ alert('Some mandatory fields are empty on this step.'); }
    return ok;
  }

  function validateAll(showAlert){
    let ok=true;
    steps.forEach((s,i)=>{ if(!validateStep(i,true)) ok=false; });
    if(!ok && showAlert) alert('Some mandatory fields are empty. They are highlighted in red.');
    return ok;
  }

  // Repeaters: questions, sectors, glossary
  const qContainer = document.getElementById('qContainer');
  const addQ = document.getElementById('addQ');
  const sectorContainer = document.getElementById('sectorContainer');
  const addSector = document.getElementById('addSector');
  const termContainer = document.getElementById('termContainer');
  const addTerm = document.getElementById('addTerm');

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function newQuestion(index){
    const id=uid();
    const wrap=document.createElement('div');
    wrap.className='repeatItem';
    wrap.dataset.qid=id;
    wrap.innerHTML=`
      <div class="repeatItemHead">
        <strong>Question module ${index}</strong>
        <small>overview, feedback themes, response, outcome</small>
        <span style="margin-left:auto"></span>
        <button class="miniBtn" data-remove="q">Remove</button>
      </div>
      <div class="grid">
        <div class="field" data-required="true">
          <label>Thematic heading (section name) <span class="flag mand">Mandatory</span></label>
          <input id="q_${id}_theme" placeholder="Example: governance and oversight" />
          <small class="hint">Used to group modules in the paper.</small>
        </div>
        <div class="field" data-required="true">
          <label>Consultation question text <span class="flag mand">Mandatory</span></label>
          <textarea id="q_${id}_qtext" placeholder="Paste the exact CP question"></textarea>
          <small class="hint">Keep this exact, do not paraphrase.</small>
        </div>
        <div class="field" data-required="true">
          <label>What the CP proposed (one paragraph) <span class="flag mand">Mandatory</span></label>
          <textarea id="q_${id}_proposal" placeholder="One paragraph summary of intent and proposed approach"></textarea>
          <small class="hint">Describe the purpose of the proposal being consulted on.</small>
        </div>
        <div class="field" data-required="true">
          <label>Feedback themes and divergence <span class="flag mand">Mandatory</span></label>
          <textarea id="q_${id}_themes" placeholder="Bullets: what respondents said, including any divergence"></textarea>
          <small class="hint">Group by common views, avoid labelling camps.</small>
        </div>
        <div class="field" data-required="true">
          <label>Regulator response position <span class="flag mand">Mandatory</span></label>
          <textarea id="q_${id}_response" placeholder="What we think and why, anchored to framework and proportionality"></textarea>
          <small class="hint">Reasoning, not rhetoric.</small>
        </div>
        <div class="field" data-required="true">
          <label>Outcome decision and delivery mechanism <span class="flag mand">Mandatory</span></label>
          <textarea id="q_${id}_outcome" placeholder="Outcome: accept/amend/defer/reject; what document changes; timing"></textarea>
          <small class="hint">One or two decisive lines plus mechanism.</small>
        </div>
        <div class="field">
          <label>Any quantitative results you trust <span class="flag">Optional</span></label>
          <textarea id="q_${id}_quant" placeholder="Example: 8 supportive, 3 mixed, 1 opposed; or leave blank"></textarea>
          <small class="hint">Only include if supported.</small>
        </div>
      </div>
    `;
    wrap.querySelector('[data-remove="q"]').addEventListener('click',()=>{ wrap.remove(); renumberQuestions(); });
    return wrap;
  }

  function renumberQuestions(){
    const qs = Array.from(qContainer.querySelectorAll('.repeatItem'));
    qs.forEach((q,i)=>{
      const h=q.querySelector('.repeatItemHead strong');
      if(h) h.textContent='Question module ' + (i+1);
    });
  }

  function newSector(index){
    const id=uid();
    const wrap=document.createElement('div');
    wrap.className='repeatItem';
    wrap.dataset.sid=id;
    wrap.innerHTML=`
      <div class="repeatItemHead">
        <strong>Sector line ${index}</strong>
        <small>sector and count</small>
        <span style="margin-left:auto"></span>
        <button class="miniBtn" data-remove="s">Remove</button>
      </div>
      <div class="grid">
        <div class="field" data-required="true">
          <label>Sector name <span class="flag mand">Mandatory</span></label>
          <input id="s_${id}_name" placeholder="Example: investment business" />
        </div>
        <div class="field" data-required="true">
          <label>Count <span class="flag mand">Mandatory</span></label>
          <input id="s_${id}_count" placeholder="Example: 5" />
        </div>
        <div class="field">
          <label>Notes <span class="flag">Optional</span></label>
          <input id="s_${id}_note" placeholder="Example: includes one association" />
        </div>
      </div>
    `;
    wrap.querySelector('[data-remove="s"]').addEventListener('click',()=>wrap.remove());
    return wrap;
  }

  function newTerm(index){
    const id=uid();
    const wrap=document.createElement('div');
    wrap.className='repeatItem';
    wrap.dataset.tid=id;
    wrap.innerHTML=`
      <div class="repeatItemHead">
        <strong>Term ${index}</strong>
        <small>glossary entry</small>
        <span style="margin-left:auto"></span>
        <button class="miniBtn" data-remove="t">Remove</button>
      </div>
      <div class="grid">
        <div class="field" data-required="true">
          <label>Term <span class="flag mand">Mandatory</span></label>
          <input id="t_${id}_term" placeholder="Example: registered person" />
        </div>
        <div class="field" data-required="true">
          <label>Definition <span class="flag mand">Mandatory</span></label>
          <textarea id="t_${id}_def" placeholder="Plain definition as used in the paper"></textarea>
        </div>
      </div>
    `;
    wrap.querySelector('[data-remove="t"]').addEventListener('click',()=>wrap.remove());
    return wrap;
  }

  addQ.addEventListener('click',()=>{
    const n = qContainer.querySelectorAll('.repeatItem').length + 1;
    qContainer.appendChild(newQuestion(n));
  });
  addSector.addEventListener('click',()=>{
    const n = sectorContainer.querySelectorAll('.repeatItem').length + 1;
    sectorContainer.appendChild(newSector(n));
  });
  addTerm.addEventListener('click',()=>{
    const n = termContainer.querySelectorAll('.repeatItem').length + 1;
    termContainer.appendChild(newTerm(n));
  });

  // seed one of each so user sees the pattern
  qContainer.appendChild(newQuestion(1));
  sectorContainer.appendChild(newSector(1));
  termContainer.appendChild(newTerm(1));

  function collect(){
    let contentsTemplate = s2TemplateEl ? s2TemplateEl.value : '';
    if(!contentsTemplate || !contentsTemplate.trim()){
      contentsTemplate = DEFAULT_CONTENTS_TEMPLATE;
      if(s2TemplateEl) s2TemplateEl.value = DEFAULT_CONTENTS_TEMPLATE;
    }
    const allowedOverrideOpen = allowedOverride?.open;
    const allowedRaw = allowedOverrideOpen ? get('g_allowed') : '';
    const allowedSource = allowedOverrideOpen ? allowedRaw : DEFAULT_ALLOWED_LIST;

    const data={
      g:{regulator:DEFAULT_REGULATOR,jurisdiction:DEFAULT_JURISDICTION,allowed:allowedSource,allowedOverrideOpen:!!allowedOverrideOpen,prefix:get('g_prefix')},
      s1:{feedbackTitle:get('s1_feedbackTitle'),consultationTitle:get('s1_consultationTitle'),pubdate:get('s1_pubdate'),url:get('s1_url'),oneliner:get('s1_oneliner'),inbox:get('s1_inbox'),issue:get('s1_issue'),ref:get('s1_ref')},
      s2:{template:contentsTemplate,isDefault:s2IsDefault},
      s3:{areas:get('s3_areas'),population:get('s3_population'),qcount:get('s3_qcount')},
      s4:{drivers:get('s4_drivers'),changed:get('s4_changed')},
      s5:{responses:get('s5_responses'),events:get('s5_events'),categories:get('s5_categories'),conf:get('s5_conf')},
      s6:{devs:get('s6_devs')},
      s7:{frame:get('s7_frame'),themes:get('s7_themes'),div:get('s7_div')},
      s8:{decisions:get('s8_decisions'),route:get('s8_route'),timeline:get('s8_timeline'),changed:get('s8_changed')},
      s9:{quant:get('s9_quant'),tone:get('s9_tone')},
      questions:[],
      sectors:[],
      terms:[]
    };

    // questions
    Array.from(qContainer.querySelectorAll('.repeatItem')).forEach(w=>{
      const id=w.dataset.qid;
      data.questions.push({
        theme:get(`q_${id}_theme`),
        qtext:get(`q_${id}_qtext`),
        proposal:get(`q_${id}_proposal`),
        themes:get(`q_${id}_themes`),
        response:get(`q_${id}_response`),
        outcome:get(`q_${id}_outcome`),
        quant:get(`q_${id}_quant`)
      });
    });

    // sectors
    Array.from(sectorContainer.querySelectorAll('.repeatItem')).forEach(w=>{
      const id=w.dataset.sid;
      data.sectors.push({name:get(`s_${id}_name`),count:get(`s_${id}_count`),note:get(`s_${id}_note`)});
    });

    // terms
    Array.from(termContainer.querySelectorAll('.repeatItem')).forEach(w=>{
      const id=w.dataset.tid;
      data.terms.push({term:get(`t_${id}_term`),def:get(`t_${id}_def`)});
    });

    return data;
  }

  function renderIfPresent(label,value){
    const v = (value||'').trim();
    return v ? `<li>${label}: ${esc(v)}</li>` : '';
  }

  function sanitizeAllowedList(raw){
    const source = (raw && raw.trim()) ? raw : DEFAULT_ALLOWED_LIST;
    const seen = new Set();
    const parts = source.split(',').map(s=>s.trim()).filter(Boolean);
    const deduped = [];
    parts.forEach(p=>{
      const key = p.toLowerCase();
      if(!seen.has(key)){
        seen.add(key);
        deduped.push(p);
      }
    });
    return deduped;
  }

  function sanitizeCollectedData(rawData, allowedList){
    const allowedSource = Array.isArray(allowedList) ? allowedList : sanitizeAllowedList(allowedList);
    const allowedNormalized = allowedSource.map(s=>s.toLowerCase());
    const allowedSet = new Set(allowedNormalized);
    const entityKeywords = ['authority','commission','government','state','states','council','board','bank','fund','union','agency','office','department','ministry','organisation','organization','court','committee','jurisdiction','regulator'];
    const entityPattern = /\b[A-Z][A-Za-z&.'-]+(?:\s+(?:of|and|the)?\s*[A-Z][A-Za-z&.'-]+){0,4}\b/g;

    function isAllowedEntity(candidate){
      const normalized = candidate.trim().toLowerCase();
      return allowedNormalized.some(entry => normalized === entry || normalized.includes(entry) || entry.includes(normalized));
    }

    function scrubString(value){
      const trimmed = (value || '').trim();
      return trimmed.replace(entityPattern, match => {
        const normalized = match.trim().toLowerCase();
        const hasKeyword = entityKeywords.some(k => normalized.includes(k));
        if(!hasKeyword) return match;
        return isAllowedEntity(match) ? match : DISALLOWED_TOKEN;
      });
    }

    function walk(value, parentKey){
      if(value === null || value === undefined) return '';
      if(typeof value === 'string'){
        if(parentKey === 'allowed') return value;
        return scrubString(value);
      }
      if(Array.isArray(value)) return value.map(v=>walk(v, parentKey));
      if(typeof value === 'object'){
        const next={};
        Object.entries(value).forEach(([k,v])=>{ next[k]=walk(v,k); });
        return next;
      }
      return value;
    }

    return walk(rawData);
  }

  function buildDoc(data){
    const now = new Date().toLocaleString('en-GB');

    const allowedList = sanitizeAllowedList(data.g.allowed);
    const sanitizedData = sanitizeCollectedData(data, allowedList);
    const regulator = (sanitizedData.g.regulator || DEFAULT_REGULATOR).trim() || DEFAULT_REGULATOR;
    const jurisdiction = (sanitizedData.g.jurisdiction || DEFAULT_JURISDICTION).trim() || DEFAULT_JURISDICTION;
    const allowedListDisplay = esc(allowedList.join(', '));
    const tone = (sanitizedData.s9.tone && sanitizedData.s9.tone.trim()) ? sanitizedData.s9.tone.trim() : 'factual, procedural, decision-led; acknowledge diverging views; apply proportionality; avoid overpromising; commit to concrete next actions; avoid advocacy';
    const quantRule = (sanitizedData.s9.quant && sanitizedData.s9.quant.trim()) ? sanitizedData.s9.quant.trim() : 'Use exact counts only where supported. Otherwise use consistent qualitative descriptors such as most, many, some, a minority.';

    const filteredQuestions = sanitizedData.questions.filter(q=>Object.values(q).some(v=>(v||'').trim().length));
    const filteredSectors = sanitizedData.sectors.filter(s=>Object.values(s).some(v=>(v||'').trim().length));
    const filteredTerms = sanitizedData.terms.filter(t=>Object.values(t).some(v=>(v||'').trim().length));
    const themeHeadings = [];
    filteredQuestions.forEach(q=>{
      const t = (q.theme||'').trim();
      if(t && !themeHeadings.includes(t)) themeHeadings.push(t);
    });

    function commonConstraints(extra){
      return `
        <ul>
          <li>Use British English.</li>
          <li>Professional regulatory audience.</li>
          <li>Use the regulator name exactly as: ${esc(regulator)}. Do not write "the regulator" unless quoting.</li>
          <li>Use jurisdiction exactly as: ${esc(jurisdiction)}.</li>
          <li>Mention only institutions and jurisdictions that appear in the allowed list (${allowedListDisplay}) or are explicitly named in the user inputs. If any input names an entity outside the allowed list, replace it with "[not included: not in allowed list]".</li>
          <li>Apply the tone and framing rules: ${esc(tone)}</li>
          <li>Quantification rule: ${esc(quantRule)}</li>
          <li>Do not restate or summarise inputs except where the template explicitly requires verbatim reproduction (e.g., consultation question text, glossary definitions, quantitative results).</li>
          <li>Output only the requested section text, no preambles.</li>
          <li>Do not start more than one sentence in a paragraph with the same first two words.</li>
          ${extra || ''}
        </ul>`;
    }

    function p(s){ return '<p>' + s + '</p>'; }

    function injectThematicHeadings(template, headings, isDefault){
      if(!isDefault) return template;
      const lines = template.split(/\n/);
      let replaced=false;
      const output=[];
      lines.forEach(line=>{
        const trimmed=line.trim();
        if(trimmed.toLowerCase().startsWith('[thematic heading')){
          if(!replaced){
            const indent = (line.match(/^\s*/) || [''])[0];
            if(headings.length){
              headings.forEach(h=>output.push(`${indent}${h}`));
            } else {
              output.push(line);
            }
            replaced=true;
          }
          return;
        }
        output.push(line);
      });
      return output.join('\n');
    }

    function buildStep10Prompt(){
      let section = `<hr/><h2>Step 10: final assembly and structure check (run last, no user input)</h2><h3>Agent prompt</h3>`;
      section += p('Run this step after completing Steps 1‚Äì9 to standardize tone and structure.');
      section += p('Assemble the full paper using outputs from Steps 1-9, then run the structure checklist below and silently correct any drift before final output. Use only provided facts; if missing, write Not reported or omit as instructed.');
      section += p('If you prefer a one-shot run, paste outputs from Steps 1‚Äì9 with this checklist and harmonize tone, capitalization, CP usage, and bullet glyphs across every section.');
      section += `<p><strong>Structure checklist:</strong></p><ul>
        <li>Cover page matches the fixed pattern (title, one sentence description, document reference, consultation line with URL and date, enquiries line, Issued line).</li>
        <li>Contents uses the fixed ordering and naming.</li>
        <li>Executive summary uses only the five subheadings: Introduction; Background; International context; Feedback summary; Policy position and next steps.</li>
        <li>All bullets in the executive summary and Industry feedback use ‚Äú‚Ä∫‚Äù.</li>
        <li>Tone, capitalization, and CP usage are harmonized across all sections, including back matter.</li>
        <li>Every question module includes all labels in order: Overview; Quantitative results; Industry feedback; Our response; Outcome:.</li>
        <li>‚ÄúOutcome:‚Äù exists for each module and is a single paragraph starting with ‚ÄúOutcome:‚Äù.</li>
        <li>CP defined once, then CP used thereafter.</li>
        <li>Respondents table header is exactly ‚ÄúSector | No. of responses‚Äù.</li>
        <li>Glossary includes the fixed boilerplate line and only user supplied terms.</li>
        <li>Delete any non-allowlisted institutions that slipped through from earlier drafts.</li>
        <li>No institutions or jurisdictions appear outside the allowed list (${allowedListDisplay}).</li>
      </ul>`;
      section += `<p><strong>Constraints:</strong></p>${commonConstraints('<li>Do not restate inputs; output only the full compiled paper.</li>')}`;
      return section;
    }

    // Step 1 prompt
    let out='';
    const exportOnlySections = [];
    out += `<h2>Step 1: frame metadata</h2>`;
    out += `<h3>Agent prompt</h3>`;
    out += p('Fill the cover page and opening description using the fixed template. Do not change labels or ordering. Use only provided facts; if a required fact is missing, write Not reported.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Feedback paper title', sanitizedData.s1.feedbackTitle)
      + renderIfPresent('Consultation title', sanitizedData.s1.consultationTitle)
      + renderIfPresent('Consultation publication date', sanitizedData.s1.pubdate)
      + renderIfPresent('Consultation URL', sanitizedData.s1.url)
      + renderIfPresent('One sentence description of this feedback paper', sanitizedData.s1.oneliner)
      + renderIfPresent('Contact inbox', sanitizedData.s1.inbox)
      + renderIfPresent('Issue month and year', sanitizedData.s1.issue)
      + renderIfPresent('Document reference / code', sanitizedData.s1.ref)
      + `</ul>`;
    out += `<p><strong>Required output template:</strong></p><pre>[feedback paper title]

[one sentence description of this feedback paper]
Document reference: [document reference / code]
This paper reports on responses received to our consultation on [consultation title] ([consultation url]) published on [consultation publication date].
Further enquiries concerning the consultation can be directed to: [contact inbox]
Issued: [issue month year]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Do not insert extra lines.</li>
      <li>Do not add a contents label on the cover page.</li>
      <li>Populate only the bracketed fields; write Not reported where an input is missing.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints()}`;
    out += `<hr/>`;

    const s2Data = sanitizedData.s2 || {};
    const contentsTemplateRaw = (s2Data.template || '').trim();
    const isDefaultTemplate = s2Data.isDefault !== false;
    const contentsTemplate = contentsTemplateRaw || DEFAULT_CONTENTS_TEMPLATE;
    const contentsTemplateForOutput = injectThematicHeadings(contentsTemplate, themeHeadings, isDefaultTemplate);

    // Step 2 prompt
    out += `<h2>Step 2: contents skeleton</h2><h3>Agent prompt</h3>`;
    out += p('Use this contents template to structure the drafted paper. Do not change labels or numbering.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Contents template', contentsTemplate)
      + renderIfPresent('Thematic headings (order preserved)', themeHeadings.join('\n'))
      + `</ul>`;
    out += `<p><strong>Required output template:</strong></p><pre>${esc(contentsTemplateForOutput)}</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>`
      + `<li>Preserve capitalisation and numbering exactly as shown.</li>`
      + `<li>List thematic headings under section 2 in the order provided${(isDefaultTemplate && themeHeadings.length) ? ' (pre-inserted below)' : ''}.</li>`
      + `<li>Do not add a contents label on the cover page; contents starts here.</li>`
    + `</ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints()}`;
    out += `<hr/>`;

    // Step 3 prompt
    out += `<h2>Step 3: consultation scope recap</h2><h3>Agent prompt</h3>`;
    out += p('Draft the Executive summary ¬∑ Introduction subsection using the fixed spine. Define ‚ÄúCP‚Äù once here, then use ‚ÄúCP‚Äù thereafter.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Consultation title', sanitizedData.s1.consultationTitle)
      + renderIfPresent('Key areas addressed', sanitizedData.s3.areas)
      + renderIfPresent('Regulated population in scope', sanitizedData.s3.population)
      + renderIfPresent('Number of consultation questions', sanitizedData.s3.qcount)
      + renderIfPresent('Engagement facts (to weave in bullets)', `${sanitizedData.s5.responses ? 'Responses: ' + sanitizedData.s5.responses + '; ' : ''}${sanitizedData.s5.events ? 'Events: ' + sanitizedData.s5.events + '; ' : ''}${sanitizedData.s5.categories ? 'Categories: ' + sanitizedData.s5.categories : ''}`)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>1. Executive summary
Introduction
[paragraph defining the CP and stating scope]
‚Ä∫ [bullet]
‚Ä∫ [bullet]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Bullet glyph must be exactly ‚Ä∫ for every bullet.</li>
      <li>Use the paragraph to define the consultation once as ‚ÄúConsultation Paper (CP) [title]‚Äù, then refer to CP thereafter.</li>
      <li>Populate bullets with scope and engagement facts; write Not reported if an input is missing.</li>
      <li>Do not add extra subheadings.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints('<li>Define ‚ÄúCP‚Äù once here, then use ‚ÄúCP‚Äù thereafter.</li>')}`;
    out += `<hr/>`;

    // Step 4 prompt
    out += `<h2>Step 4: background context</h2><h3>Agent prompt</h3>`;
    out += p('Draft the Executive summary ¬∑ Background subsection, filling only that label with concise paragraphs.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Internal drivers and programme references', sanitizedData.s4.drivers)
      + renderIfPresent('What changed since related work', sanitizedData.s4.changed)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>Background
[paragraphs]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Keep this within the Executive summary structure; do not introduce new labels.</li>
      <li>Use only provided facts; if nothing changed, write Not reported.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints()}`;
    out += `<hr/>`;

    // Step 5 prompt
    out += `<h2>Step 5: engagement facts</h2><h3>Agent prompt</h3>`;
    out += p('Draft the engagement facts lines to support the Executive summary ¬∑ Introduction bullets and the respondents narrative.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Number of formal responses', sanitizedData.s5.responses)
      + renderIfPresent('Events and participation', sanitizedData.s5.events)
      + renderIfPresent('Respondent categories', sanitizedData.s5.categories)
      + renderIfPresent('Confidentiality handling notes', sanitizedData.s5.conf)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>Introduction bullets use ‚Äú‚Ä∫‚Äù.
‚Ä∫ [response count line]
‚Ä∫ [events or categories line]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Bullet glyph must be ‚Ä∫.</li>
      <li>Use one-sentence bullets only; write Not reported if data is missing.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints()}`;
    out += `<hr/>`;

    // Step 6 prompt
    out += `<h2>Step 6: international context</h2><h3>Agent prompt</h3>`;
    const devCount = (sanitizedData.s6.devs || '').split(/\n/).map(s=>s.trim()).filter(Boolean).length;
    out += p('Draft the Executive summary ¬∑ International context subsection using only the provided external developments.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('External developments (bullets only)', sanitizedData.s6.devs)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>International context
[paragraphs or bullets]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Use only the supplied developments; do not add institutions outside the allowed list (${allowedListDisplay}).</li>
      <li>If fewer than 2 developments are provided (${devCount}), output exactly: ‚ÄúInternational context: not included in this paper.‚Äù</li>
      <li>If developments are provided, keep them as short statements (one per line or sentence).</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints()}`;
    out += `<hr/>`;

    // Step 7 prompt
    out += `<h2>Step 7: feedback themes</h2><h3>Agent prompt</h3>`;
    out += p('Draft the Executive summary ¬∑ Feedback summary subsection using the fixed bullet glyph.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Coding frame', sanitizedData.s7.frame)
      + renderIfPresent('Theme candidates', sanitizedData.s7.themes)
      + renderIfPresent('Notable divergences', sanitizedData.s7.div)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>Feedback summary
‚Ä∫ [theme bullet]
‚Ä∫ [theme bullet]
‚Ä¶</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Use glyph ‚Ä∫ for every bullet.</li>
      <li>Keep between four and six bullets unless fewer inputs exist; write Not reported if none.</li>
      <li>Do not add subheadings.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints('<li>Define ‚ÄúCP‚Äù once in Introduction; use CP thereafter.</li>')}`;
    out += `<hr/>`;

    // Step 8 prompt
    out += `<h2>Step 8: policy position and next steps</h2><h3>Agent prompt</h3>`;
    out += p('Draft the Executive summary ¬∑ Policy position and next steps subsection using the fixed paragraph-then-bullets pattern.');
    out += `<p><strong>Inputs:</strong></p><ul>`
      + renderIfPresent('Decisions list', sanitizedData.s8.decisions)
      + renderIfPresent('What changed due to feedback', sanitizedData.s8.changed)
      + renderIfPresent('Delivery route', sanitizedData.s8.route)
      + renderIfPresent('Timeline anchors', sanitizedData.s8.timeline)
      + `</ul>`;
    out += `<p><strong>Required output template slice:</strong></p><pre>Policy position and next steps
[one short paragraph]
‚Ä∫ [bullet]
‚Ä∫ [bullet]</pre>`;
    out += `<p><strong>Rules:</strong></p><ul>
      <li>Paragraph first, then bullets using glyph ‚Ä∫.</li>
      <li>Bullets should cover what changed due to feedback and next actions with timings.</li>
      <li>Do not add extra subheadings.</li>
    </ul>`;
    out += `<p><strong>Constraints:</strong></p>${commonConstraints('<li>Commit to concrete next actions; avoid overpromising.</li>')}`;
    out += `<hr/>`;

    // Step 9 prompt (includes module template + back matter)
    out += `<h2>Step 9: question modules, respondents table, glossary</h2><h3>Agent prompt</h3>`;
    out += p('Draft the main body modules, respondents section, and glossary using the fixed templates. Use only provided facts; if missing, write Not reported or omit as instructed.');

    out += `<p><strong>Inputs:</strong></p>`;
    out += `<ul>
      <li>Quantification approach: ${esc(quantRule)}</li>
      <li>Tone and framing constraints: ${esc(tone)}</li>
    </ul>`;

    out += `<p><strong>Question modules:</strong></p>`;
    if(!filteredQuestions.length){
      out += p('No question modules provided.');
    } else {
      out += '<ol>';
      filteredQuestions.forEach((q,i)=>{
        out += `<li>
          <p><strong>Thematic heading:</strong> ${esc((q.theme||'').trim())}</p>
          ${renderIfPresent('Consultation question text', q.qtext)?.replace('<li','<p').replace('</li>','</p>') || ''}
          ${renderIfPresent('What the CP proposed', q.proposal)?.replace('<li','<p').replace('</li>','</p>') || ''}
          ${renderIfPresent('Feedback themes and divergence', q.themes)?.replace('<li','<p').replace('</li>','</p>') || ''}
          ${renderIfPresent('Regulator response position', q.response)?.replace('<li','<p').replace('</li>','</p>') || ''}
          ${renderIfPresent('Outcome decision and delivery mechanism', q.outcome)?.replace('<li','<p').replace('</li>','</p>') || ''}
          ${renderIfPresent('Quantitative results (if any)', q.quant)?.replace('<li','<p').replace('</li>','</p>') || ''}
        </li>`;
      });
      out += '</ol>';
    }

    out += `<p><strong>Respondent counts by sector:</strong></p>`;
    if(!filteredSectors.length){
      out += p('Respondent breakdown: not reported in this paper.');
    } else {
      out += '<table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse">';
      out += '<tr><th>Sector</th><th>No. of responses</th></tr>';
      filteredSectors.forEach(s=>{
        const name = (s.name||'').trim() || 'Not reported';
        const count = (s.count||'').trim() || 'Not reported';
        out += `<tr><td>${esc(name)}</td><td>${esc(count)}</td></tr>`;
      });
      out += '</table>';
    }

    out += `<p><strong>Glossary:</strong></p>`;
    if(!filteredTerms.length){
      out += p('Defined terms are indicated throughout this document as follows:');
      out += p('No glossary terms provided.');
    } else {
      out += p('Defined terms are indicated throughout this document as follows:');
      out += '<table border="1" cellspacing="0" cellpadding="6" style="border-collapse:collapse">';
      out += '<tr><th>Term</th><th>Definition</th></tr>';
      filteredTerms.forEach(t=>{
        out += `<tr><td>${esc((t.term||'').trim())}</td><td>${esc((t.def||'').trim()).replace(/\n/g,'<br/>')}</td></tr>`;
      });
      out += '</table>';
    }

    out += `<p><strong>Required output templates:</strong></p><ul>
      <li>Question module spine (apply per question under its thematic heading):<pre>Q[n]. [question title]: [question text]
Overview
[overview paragraph(s)]
Quantitative results
[one line: either exact counts, or ‚ÄúNot reported‚Äù]
Industry feedback
‚Ä∫ [bullet]
‚Ä∫ [bullet]
Our response
[paragraph(s)]
Outcome:
[one paragraph starting with ‚ÄúOutcome:‚Äù]</pre></li>
      <li>Respondents section title must be ‚Äú3. List of respondents‚Äù with table header ‚ÄúSector | No. of responses‚Äù.</li>
      <li>Glossary must start with ‚ÄúDefined terms are indicated throughout this document as follows:‚Äù then a Term | Definition table using only supplied terms.</li>
    </ul>`;

    out += `<p><strong>Rules:</strong></p><ul>
      <li>Do not change labels or ordering within modules.</li>
      <li>Industry feedback bullets must use glyph ‚Ä∫ only.</li>
      <li>‚ÄúOutcome:‚Äù must be a single paragraph starting with ‚ÄúOutcome:‚Äù.</li>
      <li>Group questions under their provided thematic headings without renaming them.</li>
      <li>Use Not reported where data is missing rather than inventing content.</li>
    </ul>`;

    out += `<p><strong>Constraints:</strong></p>${commonConstraints('<li>Do not invent institutions outside the allowed list.</li>')}`;

    exportOnlySections.push(buildStep10Prompt());

    exportOnlySections.forEach(section=>{ out += section; });

    const includedStepCount = 9 + exportOnlySections.length;
    const html = `
<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40">
<head>
  <meta charset="utf-8" />
  <title>Feedback paper agent prompts</title>
  <style>
    body{font-family:Calibri,Arial,sans-serif;font-size:11pt;color:#111827}
    h1{font-size:18pt;margin-bottom:4pt}
    h2{font-size:14pt;margin-top:16pt;margin-bottom:4pt}
    h3{font-size:12pt;margin-top:8pt;margin-bottom:4pt}
    p{margin:3pt 0}
    ul,ol{margin-top:2pt;margin-bottom:6pt}
    hr{border:none;border-top:1px solid #d1d5db;margin:10pt 0}
    table{margin:6pt 0}
    th{background:#f3f4f6}
  </style>
</head>
<body>
  <h1>Feedback paper workflow ¬∑ agent prompts</h1>
  <p><strong>Generated on:</strong> ${esc(now)}</p>
  <p>This file contains ${includedStepCount} prompt${includedStepCount === 1 ? '' : 's'} (Steps 1‚Äì10 including the final assembly check), prefilled with your inputs. Paste the prompt text into your LLM agent to generate the corresponding draft sections.</p>
  ${out}
</body>
</html>`;

    return html;
  }

  function download(filename, html){
    const blob = new Blob(["\ufeff", html], {type:'application/msword'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href=url; a.download=filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  exportBtn.addEventListener('click',()=>{
    const data = collect();
    const ok = validateAll(true);

    // validate repeaters required fields
    function validateRepeater(container){
      let ok2=true;
      Array.from(container.querySelectorAll('.repeatItem')).forEach(item=>{
        const inputs = Array.from(item.querySelectorAll('textarea,input,select'));
        const hasAny = inputs.some(input => input.value && input.value.trim().length);

        // If the repeater item is completely empty, treat it as optional and clear any missing markers.
        if(!hasAny){
          Array.from(item.querySelectorAll('.field[data-required="true"]')).forEach(f=>f.classList.remove('missing'));
          return;
        }

        Array.from(item.querySelectorAll('.field[data-required="true"]')).forEach(f=>{
          const input=f.querySelector('textarea,input,select');
          const has=input && input.value && input.value.trim().length;
          if(!has){ f.classList.add('missing'); ok2=false; }
          else f.classList.remove('missing');
        });
      });
      return ok2;
    }

    const qOk = validateRepeater(qContainer);
    const sOk = validateRepeater(sectorContainer);
    const tOk = validateRepeater(termContainer);

    const finalOk = ok && qOk && sOk && tOk;
    if(!finalOk){
      const proceed = confirm('Some mandatory fields are empty (including repeatable sections). Generate the Word file anyway?');
      if(!proceed) return;
    }

    const doc = buildDoc(data);
    const ref = (data.s1.ref || '').trim();
    const safeRef = ref ? ref.replace(/[^A-Za-z0-9_]+/g,'_') : '';
    const prefix = (data.g.prefix || '').trim().replace(/[^A-Za-z0-9_]+/g,'_');
    const base = safeRef ? `feedback_paper_agent_prompts_${safeRef}` : 'feedback_paper_agent_prompts';
    const name = `${prefix || ''}${base}.doc`;
    download(name, doc);
  });

  show(0);
})();
</script>
</body>
</html>
